# CACTç¼–è¯‘å™¨å‰ç«¯

## é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªCACTè¯­è¨€ç¼–è¯‘å™¨å‰ç«¯ï¼Œä¸“é—¨ä¸ºç¼–è¯‘åŸç†è¯¾ç¨‹è®¾è®¡ã€‚ç¼–è¯‘å™¨å°†CACTæºä»£ç ç¼–è¯‘ä¸ºLLVM IRä¸­é—´ä»£ç ï¼Œä¾›å­¦ç”Ÿè¿›è¡Œåç«¯å¼€å‘å’Œä¼˜åŒ–å®ç°ã€‚

### ä»€ä¹ˆæ˜¯CACT?

CACTæ˜¯ä¸€ä¸ªç”¨äºæ•™å­¦çš„ç±»Cç¼–ç¨‹è¯­è¨€ï¼Œæ”¯æŒåŸºæœ¬çš„æ•°æ®ç±»å‹ã€æ§åˆ¶ç»“æ„å’Œå‡½æ•°ã€‚æœ¬ç¼–è¯‘å™¨å®ç°äº†å®Œæ•´çš„CACTè¯­è¨€å‰ç«¯ï¼ŒåŒ…æ‹¬è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æå’ŒLLVM IRä»£ç ç”Ÿæˆã€‚

## æ ¸å¿ƒç‰¹æ€§

- **ğŸ¯ æ•™å­¦å¯¼å‘**ï¼šä¸“ä¸ºç¼–è¯‘åŸç†è¯¾ç¨‹è®¾è®¡ï¼Œä»£ç ç»“æ„æ¸…æ™°æ˜“æ‡‚
- **âš¡ è½»é‡é«˜æ•ˆ**ï¼šä»…50ä¸ªæºæ–‡ä»¶ï¼Œ396KBä»£ç ï¼Œç¼–è¯‘é€Ÿåº¦æå¿«
- **ğŸ—ï¸ æ¨¡å—åŒ–è®¾è®¡**ï¼šå‰ç«¯(frontend)ã€ä¸­é—´è¡¨ç¤º(mir)ã€å·¥å…·(util)ä¸‰å¤§æ¨¡å—
- **âœ… åŠŸèƒ½å®Œæ•´**ï¼šæ”¯æŒCACTè¯­è¨€çš„æ‰€æœ‰åŸºæœ¬ç‰¹æ€§
- **ğŸ§ª å……åˆ†æµ‹è¯•**ï¼š33ä¸ªåŠŸèƒ½æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–æ‰€æœ‰è¯­è¨€ç‰¹æ€§
- **ğŸ“Š è¿‡ç¨‹é€æ˜**ï¼šä¿ç•™å®Œæ•´ç¼–è¯‘ä¸­é—´ç»“æœï¼Œä¾¿äºå­¦ä¹ å’Œè°ƒè¯•

## æ”¯æŒçš„CACTè¯­è¨€ç‰¹æ€§

### æ•°æ®ç±»å‹
- `int` - 32ä½æ•´æ•°
- `float` - 32ä½æµ®ç‚¹æ•°
- `char` - å­—ç¬¦ç±»å‹
- ä¸€ç»´å’Œå¤šç»´æ•°ç»„

### æ§åˆ¶ç»“æ„
- `if-else` æ¡ä»¶è¯­å¥
- `while` å¾ªç¯
- `for` å¾ªç¯
- `break` å’Œ `continue`

### å‡½æ•°ç‰¹æ€§
- å‡½æ•°å®šä¹‰å’Œè°ƒç”¨
- å‚æ•°ä¼ é€’
- è¿”å›å€¼
- é€’å½’å‡½æ•°

### å†…ç½®å‡½æ•°
- `get_int()` - è¯»å–æ•´æ•°
- `get_char()` - è¯»å–å­—ç¬¦
- `get_float()` - è¯»å–æµ®ç‚¹æ•°
- `print_int(int)` - è¾“å‡ºæ•´æ•°
- `print_char(char)` - è¾“å‡ºå­—ç¬¦
- `print_float(float)` - è¾“å‡ºæµ®ç‚¹æ•°

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Linuxæ“ä½œç³»ç»Ÿ
- GCCæˆ–Clangç¼–è¯‘å™¨
- CMake 3.10+
- LLVMå·¥å…·é“¾ï¼ˆç”¨äºè¿è¡Œç”Ÿæˆçš„IRï¼‰

### æ„å»ºç¼–è¯‘å™¨

```bash
# å…‹éš†é¡¹ç›®ï¼ˆå¦‚æœä»Gitè·å–ï¼‰
git clone --recursive https://github.com/ucas-compiler/cact-compiler.git
# git submodule update --init --recursive
cd ucas_compiler

# ä¸€é”®æ„å»º
./build.sh
```

æ„å»ºæˆåŠŸåï¼Œç¼–è¯‘å™¨ä½äº `build/compiler`

### æœ€å°ç¤ºä¾‹ï¼šç¼–è¯‘è¿è¡Œç¬¬ä¸€ä¸ªCACTç¨‹åº

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­æ¥äº†è§£å®Œæ•´çš„ç¼–è¯‘æµç¨‹ï¼š

#### 1. æŸ¥çœ‹ç¤ºä¾‹ç¨‹åº
```bash
# æŸ¥çœ‹æœ€ç®€å•çš„CACTç¨‹åº
cat testcases/functional/00.cact
```
è¾“å‡ºï¼š
```c
int main(){
    return 3;
}
```

#### 2. ç¼–è¯‘ä¸ºLLVM IR
```bash
# ç¼–è¯‘CACTæºç ä¸ºLLVM IR
build/compiler -emit-ir hello.ll testcases/functional/00.cact
```

#### 3. æŸ¥çœ‹ç”Ÿæˆçš„LLVM IR
```bash
# æŸ¥çœ‹ç”Ÿæˆçš„ä¸­é—´ä»£ç 
cat hello.ll
```
è¾“å‡ºï¼š
```llvm
declare i32 @get_char()
declare float @get_float()
declare i32 @get_int()
declare void @print_char(i32)
declare void @print_float(float)
declare void @print_int(i32)

define dso_local i32 @main() {
b1:
        ret i32 3
}
```

#### 4. ç¼–è¯‘è¿è¡Œæ—¶åº“
```bash
# ç¼–è¯‘Cè¿è¡Œæ—¶åº“
clang -c runtime.c -o runtime.o
```

#### 5. é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
```bash
# é“¾æ¥IRå’Œè¿è¡Œæ—¶åº“
clang hello.ll runtime.o -o hello
```

#### 6. è¿è¡Œç¨‹åº
```bash
# è¿è¡Œç¨‹åº,å¹¶æ£€æŸ¥é€€å‡ºçŠ¶æ€ç 
./hello; echo $?
```
è¾“å‡ºï¼š
```
3
```

#### 7. éªŒè¯ç»“æœ
```bash
# æŸ¥çœ‹æœŸæœ›è¾“å‡º
cat testcases/functional/00.out
```
è¾“å‡ºï¼š
```
3
```

âœ… ç¼–è¯‘å’Œè¿è¡ŒæˆåŠŸï¼ç¨‹åºæ­£ç¡®è¿”å›äº†é€€å‡ºç 3ã€‚

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç¼–è¯‘å‘½ä»¤
```bash
# ç¼–è¯‘CACTç¨‹åºä¸ºLLVM IR
build/compiler -emit-ir output.ll input.cact

# ç¼–è¯‘è¿è¡Œæ—¶åº“ï¼ˆä¸€æ¬¡æ€§æ“ä½œï¼‰
clang -c runtime.c -o runtime.o

# é“¾æ¥å¹¶ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
clang output.ll runtime.o -o program

# è¿è¡Œç¨‹åº
./program
```

### å¤„ç†æœ‰è¾“å…¥çš„ç¨‹åº
```bash
# å¦‚æœç¨‹åºéœ€è¦è¾“å…¥ï¼ˆå¦‚æµ‹è¯•ç”¨ä¾‹28ï¼‰
build/compiler -emit-ir test28.ll testcases/functional/28.cact
clang test28.ll runtime.o -o test28

# ä½¿ç”¨è¾“å…¥æ–‡ä»¶è¿è¡Œ
./test28 < testcases/functional/28.in
```

## æ‰¹é‡æµ‹è¯•

### å¿«é€Ÿæµ‹è¯•æ‰€æœ‰ç”¨ä¾‹
```bash
# è¿è¡Œæ‰€æœ‰33ä¸ªåŠŸèƒ½æµ‹è¯•
chmod +x test_all.sh
./test_all.sh
```

### è¯¦ç»†æµ‹è¯•æµç¨‹
```bash
chmod +x test_detailed.sh
# æŸ¥çœ‹è¯¦ç»†çš„ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹ï¼ˆæµ‹è¯•ç‰¹å®šç”¨ä¾‹ï¼‰
./test_detailed.sh 00 06 28

# æŸ¥çœ‹æ‰€æœ‰æµ‹è¯•çš„è¯¦ç»†è¿‡ç¨‹
./test_detailed.sh $(ls testcases/functional/*.cact | xargs -I {} basename {} .cact)
```

è¯¦ç»†æµ‹è¯•ä¼šåœ¨`test_results/`ç›®å½•ä¸‹ä¸ºæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹åˆ›å»ºç‹¬ç«‹æ–‡ä»¶å¤¹ï¼ŒåŒ…å«ï¼š
- æºä»£ç æ–‡ä»¶
- è¾“å…¥æ–‡ä»¶ï¼ˆå¦‚æœ‰ï¼‰
- æœŸæœ›è¾“å‡º
- ç”Ÿæˆçš„LLVM IR
- å¯æ‰§è¡Œæ–‡ä»¶
- å®é™…è¾“å‡º
- ç¼–è¯‘å’Œé“¾æ¥æ—¥å¿—

## æµ‹è¯•ç”¨ä¾‹ç±»å‹

### åŸºç¡€è¯­æ³•æµ‹è¯•
```c
// æµ‹è¯•ç”¨ä¾‹ 00: æœ€ç®€ç¨‹åº
int main(){
    return 3;
}
```

### å˜é‡å’Œè¿ç®—æµ‹è¯•
```c
// æµ‹è¯•ç”¨ä¾‹ 06: å¸¸é‡å®šä¹‰
int main(){
    const int a = 10, b = 5;
    return b;
}
```

### è¾“å…¥è¾“å‡ºæµ‹è¯•
```c
// æµ‹è¯•ç”¨ä¾‹ 28: I/Oäº¤äº’
int g = 0;
int func(int n) {
    g = g + n;
    print_int(g);
    return g;
}
int main() {
    // å¤æ‚çš„I/Oé€»è¾‘...
}
```

## é¡¹ç›®ç»“æ„

```
ucas_compiler/
â”œâ”€â”€ build/                    # æ„å»ºç›®å½•
â”‚   â””â”€â”€ compiler              # ç¼–è¯‘å™¨å¯æ‰§è¡Œæ–‡ä»¶
â”œâ”€â”€ src/                      # æºä»£ç  (24ä¸ªæ–‡ä»¶, 196KB)
â”‚   â”œâ”€â”€ frontend/             # å‰ç«¯ï¼šè¯æ³•ã€è¯­æ³•ã€è¯­ä¹‰åˆ†æ
â”‚   â”œâ”€â”€ mir/                  # ä¸­é—´è¡¨ç¤º(MIR)
â”‚   â”œâ”€â”€ util/                 # å·¥å…·ç±»
â”‚   â””â”€â”€ Compiler.cpp          # ç¼–è¯‘å™¨ä¸»ç¨‹åº
â”œâ”€â”€ include/                  # å¤´æ–‡ä»¶ (26ä¸ªæ–‡ä»¶, 200KB)
â”‚   â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ mir/
â”‚   â””â”€â”€ util/
â”œâ”€â”€ testcases/functional/     # åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹ (33ä¸ªæµ‹è¯•)
â”œâ”€â”€ runtime.c                 # CACTè¿è¡Œæ—¶åº“
â”œâ”€â”€ build.sh                  # æ„å»ºè„šæœ¬
â”œâ”€â”€ test_all.sh              # æ‰¹é‡æµ‹è¯•è„šæœ¬
â”œâ”€â”€ test_detailed.sh         # è¯¦ç»†æµ‹è¯•è„šæœ¬
â”œâ”€â”€ CMakeLists.txt           # æ„å»ºé…ç½®
â””â”€â”€ README_CACT.md           # é¡¹ç›®æ–‡æ¡£
```

## ç¼–è¯‘å™¨æ¶æ„

### ç¼–è¯‘æµç¨‹
```
CACTæºç  â†’ è¯æ³•åˆ†æ â†’ è¯­æ³•åˆ†æ â†’ è¯­ä¹‰åˆ†æ â†’ LLVM IR
```

### æ ¸å¿ƒæ¨¡å—

#### 1. Frontendï¼ˆå‰ç«¯ï¼‰
- **è¯æ³•åˆ†æå™¨**ï¼šå°†æºç åˆ†è§£ä¸ºtokens
- **è¯­æ³•åˆ†æå™¨**ï¼šæ„å»ºæŠ½è±¡è¯­æ³•æ ‘(AST)
- **è¯­ä¹‰åˆ†æå™¨**ï¼šç±»å‹æ£€æŸ¥ã€ä½œç”¨åŸŸåˆ†æ
- **ä»£ç ç”Ÿæˆå™¨**ï¼šå°†ASTè½¬æ¢ä¸ºLLVM IR

#### 2. MIRï¼ˆä¸­é—´è¡¨ç¤ºï¼‰
- **åŸºæœ¬å—**ï¼šç¨‹åºçš„åŸºæœ¬æ‰§è¡Œå•å…ƒ
- **æŒ‡ä»¤è¡¨ç¤º**ï¼šLLVM IRæŒ‡ä»¤çš„å†…éƒ¨è¡¨ç¤º
- **ç¬¦å·è¡¨**ï¼šå˜é‡å’Œå‡½æ•°çš„ç¬¦å·ä¿¡æ¯

#### 3. Utilï¼ˆå·¥å…·ï¼‰
- **ç®¡ç†å™¨**ï¼šç¼–è¯‘è¿‡ç¨‹ç®¡ç†
- **è¿è¡Œæ—¶å‡½æ•°**ï¼šå†…ç½®å‡½æ•°å£°æ˜å’Œè°ƒç”¨

## è¿è¡Œæ—¶åº“è¯¦è§£

è¿è¡Œæ—¶åº“ `runtime.c` æä¾›äº†CACTç¨‹åºä¸ç³»ç»Ÿçš„æ¥å£ï¼š

```c
// è¾“å…¥å‡½æ•°
int get_int();        // ä»æ ‡å‡†è¾“å…¥è¯»å–æ•´æ•°
char get_char();      // ä»æ ‡å‡†è¾“å…¥è¯»å–å­—ç¬¦
float get_float();    // ä»æ ‡å‡†è¾“å…¥è¯»å–æµ®ç‚¹æ•°

// è¾“å‡ºå‡½æ•°
void print_int(int);    // è¾“å‡ºæ•´æ•°åˆ°æ ‡å‡†è¾“å‡º
void print_char(char);  // è¾“å‡ºå­—ç¬¦åˆ°æ ‡å‡†è¾“å‡º
void print_float(float); // è¾“å‡ºæµ®ç‚¹æ•°åˆ°æ ‡å‡†è¾“å‡º
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•è¦†ç›–èŒƒå›´
æ‰€æœ‰33ä¸ªæµ‹è¯•ç”¨ä¾‹éªŒè¯äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

- âœ… **åŸºç¡€è¯­æ³•**ï¼šå˜é‡å£°æ˜ã€å¸¸é‡å®šä¹‰ã€åŸºæœ¬è¿ç®—
- âœ… **æ§åˆ¶æµ**ï¼šif-elseã€whileå¾ªç¯ã€forå¾ªç¯
- âœ… **å‡½æ•°**ï¼šå‡½æ•°å®šä¹‰ã€è°ƒç”¨ã€å‚æ•°ä¼ é€’ã€é€’å½’
- âœ… **æ•°ç»„**ï¼šä¸€ç»´æ•°ç»„ã€å¤šç»´æ•°ç»„ã€æ•°ç»„è®¿é—®
- âœ… **ç±»å‹ç³»ç»Ÿ**ï¼šintã€floatã€charç±»å‹åŠè½¬æ¢
- âœ… **è¾“å…¥è¾“å‡º**ï¼šæ‰€æœ‰6ä¸ªå†…ç½®I/Oå‡½æ•°
- âœ… **ä½œç”¨åŸŸ**ï¼šå…¨å±€å˜é‡ã€å±€éƒ¨å˜é‡ã€å‡½æ•°å‚æ•°
- âœ… **è¡¨è¾¾å¼**ï¼šç®—æœ¯ã€é€»è¾‘ã€å…³ç³»è¿ç®—

### æµ‹è¯•ç»“æœç¤ºä¾‹
```
Testing CACT compiler on functional test cases...
PASS: 00
PASS: 01
PASS: 02
...
PASS: 32

Results: 33 passed, 0 failed out of 33 total tests
All tests passed!
```

## æ‰©å±•å¼€å‘

### ä¸ºè¯¾ç¨‹å­¦ä¹ å‡†å¤‡
æœ¬ç¼–è¯‘å™¨å‰ç«¯ä¸ºå­¦ç”Ÿæä¾›äº†å®Œæ•´çš„åŸºç¡€ï¼š

1. **åç«¯å¼€å‘**ï¼šå­¦ç”Ÿå¯ä»¥åŸºäºç”Ÿæˆçš„LLVM IRå®ç°ç›®æ ‡ä»£ç ç”Ÿæˆ
2. **ä¼˜åŒ–å®ç°**ï¼šå¯ä»¥åœ¨MIRé˜¶æ®µæ·»åŠ å„ç§ç¼–è¯‘ä¼˜åŒ–
3. **è¯­è¨€æ‰©å±•**ï¼šå¯ä»¥æ‰©å±•CACTè¯­è¨€ç‰¹æ€§
4. **è°ƒè¯•å·¥å…·**ï¼šå¯ä»¥åŸºäºç°æœ‰æ¡†æ¶å¼€å‘è°ƒè¯•å’Œåˆ†æå·¥å…·

### å¼€å‘å»ºè®®
```bash
# å¼€å‘æ—¶çš„å¢é‡æ„å»º
cd build && make

# æ¸…ç†é‡æ–°æ„å»º
rm -rf build && ./build.sh

# æµ‹è¯•ç‰¹å®šåŠŸèƒ½
./test_detailed.sh 00 06 17  # æµ‹è¯•åŸºç¡€åŠŸèƒ½
./test_detailed.sh 24 25 28  # æµ‹è¯•å¤æ‚åŠŸèƒ½
```

## å¸¸è§é—®é¢˜

### Q: ç¼–è¯‘å™¨æŠ¥é”™å¦‚ä½•è°ƒè¯•ï¼Ÿ
A: æŸ¥çœ‹ç¼–è¯‘å™¨çš„é”™è¯¯è¾“å‡ºï¼Œé€šå¸¸ä¼šæŒ‡æ˜å…·ä½“çš„è¯­æ³•æˆ–è¯­ä¹‰é”™è¯¯ä½ç½®ã€‚

### Q: ç”Ÿæˆçš„LLVM IRå¦‚ä½•æŸ¥çœ‹ï¼Ÿ
A: ä½¿ç”¨ `-emit-ir` å‚æ•°åï¼ŒIRæ–‡ä»¶ä¸ºæ–‡æœ¬æ ¼å¼ï¼Œå¯ä»¥ç›´æ¥ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æŸ¥çœ‹ã€‚

### Q: å¦‚ä½•æ·»åŠ æ–°çš„å†…ç½®å‡½æ•°ï¼Ÿ
A: åœ¨ `runtime.c` ä¸­å®ç°å‡½æ•°ï¼Œåœ¨ `include/util/FrontendInit.h` ä¸­å£°æ˜ã€‚

### Q: æµ‹è¯•å¤±è´¥å¦‚ä½•åˆ†æï¼Ÿ
A: ä½¿ç”¨ `./test_detailed.sh` æŸ¥çœ‹è¯¦ç»†çš„ç¼–è¯‘å’Œè¿è¡Œè¿‡ç¨‹ï¼Œæ£€æŸ¥ä¸­é—´ç»“æœã€‚

## å­¦ä¹ èµ„æº

- **ç¼–è¯‘åŸç†æ•™æ**ï¼šæ¨èé¾™ä¹¦(Compilers: Principles, Techniques, and Tools)
- **LLVMæ–‡æ¡£**ï¼šhttps://llvm.org/docs/
- **CACTè¯­è¨€è§„èŒƒ**ï¼šå‚è€ƒæµ‹è¯•ç”¨ä¾‹äº†è§£è¯­è¨€ç‰¹æ€§
- **é¡¹ç›®æºç **ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œé€‚åˆé€æ­¥å­¦ä¹ 

---

ğŸ“ **è¯¾ç¨‹æç¤º**ï¼šæœ¬é¡¹ç›®ä¸ºç¼–è¯‘åŸç†è¯¾ç¨‹çš„å‰ç«¯éƒ¨åˆ†ï¼Œå­¦ç”Ÿéœ€è¦åœ¨æ­¤åŸºç¡€ä¸Šå®ç°åç«¯ä»£ç ç”Ÿæˆå’Œä¼˜åŒ–ã€‚ç¥å­¦ä¹ æ„‰å¿«ï¼ 